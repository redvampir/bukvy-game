<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ë—É–∫–≤–µ–Ω–Ω–∞—è –∏–≥—Ä–∞</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body {
      font-family: system-ui, Arial;
      text-align:center;
      margin:0;
      padding: 16px;
      padding-top: calc(16px + env(safe-area-inset-top));
      padding-right: calc(16px + env(safe-area-inset-right));
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      padding-left: calc(16px + env(safe-area-inset-left));
      background:#fff7e6;
      transition: background 0.3s ease;
    }
    body.dark-theme { background:#1a1a2e; color:#eee; }
    
    .card { max-width:860px; margin:0 auto; background:white; border-radius:18px; padding:18px; box-shadow:0 10px 25px rgba(0,0,0,.08); }
    .dark-theme .card { background:#16213e; box-shadow:0 10px 25px rgba(0,0,0,.3); }
    
    h1 { margin: 8px 0 10px; font-size: 32px; }
    .big { font-size:92px; margin:10px 0 4px; transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
    .big.bounce { animation: bounce 0.5s ease; }
    .big.shake { animation: shake 0.4s ease; }
    
    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    
    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(500px) rotate(720deg); opacity: 0; }
    }
    
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: #f0f;
      z-index: 9999;
      animation: confetti 2s ease-out forwards;
      pointer-events: none;
    }
    
    .hint { font-size:14px; opacity:.85; margin: 6px 0; line-height: 1.4; }
    .dark-theme .hint { opacity:.7; }
    
    .status { margin-top:10px; font-size:18px; min-height: 28px; font-weight: 500; }
    
    button { font-size:16px; padding:10px 14px; border:0; border-radius:12px; background:#ff7a00; color:white; cursor:pointer; transition: all 0.2s ease; }
    button.secondary { background:#ffd7b0; color:#4a2a00; }
    button:active { transform: scale(0.98); }
    .row { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:10px; }

    @media (hover: hover) and (pointer: fine) {
      button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255,122,0,0.3); }
      button.secondary:hover { background:#ffcda0; }
      .tile:hover { transform: scale(1.05); }
      .theme-toggle:hover, .sound-toggle:hover { transform: scale(1.1); }
    }

    .grid { display:grid; grid-template-columns: repeat(5, minmax(64px, 1fr)); gap:12px; margin-top:14px; }
    .keypad { display:grid; grid-template-columns: repeat(3, minmax(64px, 1fr)); gap:12px; margin-top:14px; }
    
    .tile {
      font-size:42px; padding:18px 0; border-radius:16px; border:2px solid #f2f2f2;
      background:#fafafa; cursor:pointer; user-select:none;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
    }
    .keypad .tile { font-size:36px; }
    .dark-theme .tile { background:#0f3460; border-color:#1a4d7a; color:#fff; }
    .tile:active { transform: scale(0.98); }
    .tile.good { background:#d9fbe1; border-color:#56c271; animation: pulse 0.3s ease; }
    .tile.bad { background:#ffe0e0; border-color:#ff6b6b; animation: shake 0.3s ease; }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .dark-theme .tile.good { background:#1e4d2b; border-color:#56c271; }
    .dark-theme .tile.bad { background:#4d1e1e; border-color:#ff6b6b; }

    .bar { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; align-items:center; margin-top:10px; }
    .pill { background:#f2f2f2; padding:6px 10px; border-radius:999px; font-size:13px; transition: background 0.2s ease; white-space: nowrap; }
    .dark-theme .pill { background:#0f3460; }
    select { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; background: white; font-size: 13px; max-width: 100%; }
    input[type="checkbox"] { width: 18px; height: 18px; margin: 0; vertical-align: middle; accent-color: #ff7a00; cursor: pointer; }
    .dark-theme select { background:#0f3460; color:#fff; border-color:#1a4d7a; }
    .kbd { background:#f2f2f2; padding:4px 8px; border-radius:10px; font-weight:700; }
    .dark-theme .kbd { background:#0f3460; }

    .select-pill { display: flex; flex-direction: column; align-items: center; gap: 4px; white-space: normal; }
    .select-pill div { font-size: 11px; }
    .set-toggle { display: flex; gap: 6px; width: 100%; justify-content: center; flex-wrap: wrap; max-width: 100%; }
    .set-radio {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    .set-btn {
      flex: 1 1 auto;
      min-width: 90px;
      min-height: 36px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: white;
      color: #4a2a00;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
    }
    .set-radio:checked + .set-btn {
      background: #ff7a00;
      color: white;
      border-color: #ff7a00;
    }
    .set-radio:focus-visible + .set-btn {
      outline: 3px solid #ff7a00;
      outline-offset: 2px;
    }
    .dark-theme .set-btn { background: #0f3460; border-color: #1a4d7a; color: #fff; }
    .dark-theme .set-radio:checked + .set-btn { background: #ffd700; border-color: #ffd700; color: #1a1a2e; }
    .toggle-pill { white-space: normal; }
    .toggle-label { display: flex; align-items: center; gap: 8px; justify-content: flex-start; text-align: left; line-height: 1.2; cursor: pointer; }
    .toggle-label input[type="checkbox"] { flex: 0 0 auto; }
    
    /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
    .progress-container { margin: 12px 0; background: #e0e0e0; border-radius: 999px; height: 28px; overflow: hidden; position: relative; }
    .dark-theme .progress-container { background: #0f3460; }
    .progress-bar { 
      height: 100%; 
      background: linear-gradient(90deg, #56c271, #4caf50); 
      transition: width 0.3s ease; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      color: white; 
      font-weight: bold; 
      font-size: 13px;
      min-width: 40px;
    }
    
    /* –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è */
    .achievements { display: flex; gap: 6px; justify-content: center; margin: 10px 0; flex-wrap: wrap; }
    .achievement { font-size: 28px; opacity: 0.3; transition: all 0.3s ease; filter: grayscale(100%); }
    .achievement.unlocked { opacity: 1; filter: grayscale(0%); animation: pop 0.5s ease; }
    
    @keyframes pop {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }
    
    /* –ò—Å—Ç–æ—Ä–∏—è */
    .history { margin: 12px 0; display: flex; gap: 6px; justify-content: center; flex-wrap: wrap; min-height: 40px; }
    .history-item { font-size: 22px; width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 2px solid #f2f2f2; }
    .dark-theme .history-item { border-color: #1a4d7a; background: #0f3460; }
    .history-item.correct { background: #d9fbe1; border-color: #56c271; }
    .history-item.incorrect { background: #ffe0e0; border-color: #ff6b6b; }
    .dark-theme .history-item.correct { background: #1e4d2b; }
    .dark-theme .history-item.incorrect { background: #4d1e1e; }
    
    /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã */
    .theme-toggle { position: fixed; top: calc(15px + env(safe-area-inset-top)); right: calc(15px + env(safe-area-inset-right)); background: #ff7a00; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 22px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: all 0.2s ease; z-index: 1000; }
    .dark-theme .theme-toggle { background: #ffd700; }
    
    /* –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä */
    .sound-toggle { position: fixed; top: calc(70px + env(safe-area-inset-top)); right: calc(15px + env(safe-area-inset-right)); background: #4caf50; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 22px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: all 0.2s ease; z-index: 1000; }
    .sound-toggle.muted { background: #999; }
    
    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width: 600px) {
      body {
        padding: 12px;
        padding-top: calc(12px + env(safe-area-inset-top));
        padding-right: calc(12px + env(safe-area-inset-right));
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
        padding-left: calc(12px + env(safe-area-inset-left));
      }
      .card { padding: 14px; border-radius: 14px; }
      h1 { font-size: 24px; margin: 6px 0 8px; }
      .big { font-size: 72px; }
      .hint { font-size: 12px; }
      .status { font-size: 16px; }
      
      .bar { gap: 6px; margin-top: 8px; }
      .pill { padding: 8px 10px; font-size: 12px; white-space: normal; text-align: center; }
      select { font-size: 12px; padding: 10px 12px; width: 100%; max-width: 100%; transform: none; min-height: 40px; }
      
      .select-pill { flex: 1 1 100%; max-width: 100%; white-space: normal; }
      .set-toggle { gap: 6px; width: 100%; }
      .set-btn { min-width: 0; flex: 1 1 calc(33.333% - 4px); min-height: 40px; font-size: 11px; padding: 10px 6px; }
      
      .toggle-pill { flex: 1 1 100%; max-width: 100%; }
      .toggle-label { font-size: 11px; justify-content: center; gap: 6px; }
      input[type="checkbox"] { width: 18px; height: 18px; }
      
      button { font-size: 14px; padding: 10px 12px; min-height: 40px; }
      .row { gap: 6px; }
      
      .grid { grid-template-columns: repeat(3, minmax(70px, 1fr)); gap: 10px; margin-top: 12px; }
      .keypad { grid-template-columns: repeat(3, minmax(70px, 1fr)); gap: 10px; margin-top: 12px; }
      .tile { font-size: 40px; padding: 16px 0; }
      .keypad .tile { font-size: 34px; }
      
      .progress-container { height: 24px; margin: 10px 0; }
      .progress-bar { font-size: 11px; min-width: 35px; }
      
      .achievements { gap: 4px; margin: 8px 0; }
      .achievement { font-size: 24px; }
      
      .history { gap: 4px; min-height: 38px; }
      .history-item { font-size: 18px; width: 32px; height: 32px; }
      
      .theme-toggle, .sound-toggle { width: 40px; height: 40px; font-size: 20px; }
      .theme-toggle { top: calc(10px + env(safe-area-inset-top)); right: calc(10px + env(safe-area-inset-right)); }
      .sound-toggle { top: calc(60px + env(safe-area-inset-top)); right: calc(10px + env(safe-area-inset-right)); }
      
      .kbd { font-size: 11px; padding: 3px 6px; }
      input[type="checkbox"] { width: 20px; height: 20px; }
      .toggle-pill { flex: 1 1 100%; max-width: 100%; }
    }
    
    @media (max-width: 400px) {
      .card { padding: 12px; }
      .big { font-size: 64px; }
      .grid { grid-template-columns: repeat(3, minmax(60px, 1fr)); gap: 8px; }
      .keypad { grid-template-columns: repeat(3, minmax(60px, 1fr)); gap: 8px; }
      .tile { font-size: 36px; padding: 14px 0; }
      .keypad .tile { font-size: 30px; }
      .pill { font-size: 10px; padding: 4px 7px; }
    }
    .sound-toggle.muted { background: #999; }
  </style>
</head>
<body>
  <button class="theme-toggle" id="themeToggle">üåô</button>
  <button class="sound-toggle" id="soundToggle">üîä</button>
  
  <div class="card">
    <h1>–ù–∞–∂–º–∏ –±—É–∫–≤—É üéà</h1>
    <div class="hint">–ò–≥—Ä–∞ –≥–æ–≤–æ—Ä–∏—Ç –±—É–∫–≤—É. –†–µ–±—ë–Ω–æ–∫ –Ω–∞–∂–∏–º–∞–µ—Ç –µ—ë –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –∏–ª–∏ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ.</div>

    <div class="big" id="target">‚Äî</div>
    
    <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
    <div class="achievements" id="achievements">
      <span class="achievement" data-level="5" title="5 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–¥—Ä—è–¥">‚≠ê</span>
      <span class="achievement" data-level="10" title="10 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–¥—Ä—è–¥">üåü</span>
      <span class="achievement" data-level="20" title="20 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–¥—Ä—è–¥">‚ú®</span>
      <span class="achievement" data-level="50" title="50 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–¥—Ä—è–¥">üèÜ</span>
    </div>
    
    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
    <div class="progress-container">
      <div class="progress-bar" id="progressBar" style="width: 0%;">0%</div>
    </div>

    <div class="bar">
      <span class="pill">–û—á–∫–∏: <b id="score">0</b></span>
      <span class="pill">–û—à–∏–±–∫–∏: <b id="mistakes">0</b></span>
      <span class="pill">–ü–æ–¥—Ä—è–¥: <b id="streak">0</b> üî•</span>
      <span class="pill">–¢–æ—á–Ω–æ—Å—Ç—å: <b id="accuracy">100%</b></span>
      <span class="pill" id="numberInputWrap" hidden>–í–≤–æ–¥: <b id="numberInput">‚Äî</b></span>

      <div class="pill select-pill">
        <div>–†–µ–∂–∏–º:</div>
        <div class="set-toggle" id="modeToggle" role="radiogroup" aria-label="–†–µ–∂–∏–º">
          <input class="set-radio" type="radio" name="mode" id="mode-letters" value="letters" checked>
          <label class="set-btn" for="mode-letters">–ë—É–∫–≤—ã</label>

          <input class="set-radio" type="radio" name="mode" id="mode-numbers" value="numbers">
          <label class="set-btn" for="mode-numbers">–¶–∏—Ñ—Ä—ã</label>
        </div>
      </div>

      <div class="pill select-pill" id="letterSetWrap">
        <div>–ù–∞–±–æ—Ä:</div>
        <div class="set-toggle" id="setToggle" role="radiogroup" aria-label="–ù–∞–±–æ—Ä –±—É–∫–≤">
          <input class="set-radio" type="radio" name="set" id="set-easy" value="easy" checked>
          <label class="set-btn" for="set-easy">–õ—ë–≥–∫–∏–π</label>

          <input class="set-radio" type="radio" name="set" id="set-vowels" value="vowels">
          <label class="set-btn" for="set-vowels">–ì–ª–∞—Å–Ω—ã–µ</label>

          <input class="set-radio" type="radio" name="set" id="set-all" value="all">
          <label class="set-btn" for="set-all">–í—Å–µ –±—É–∫–≤—ã</label>
        </div>
      </div>

      <div class="pill select-pill" id="numberSetWrap" hidden>
        <div>–°–ª–æ–∂–Ω–æ—Å—Ç—å:</div>
        <div class="set-toggle" id="numberToggle" role="radiogroup" aria-label="–°–ª–æ–∂–Ω–æ—Å—Ç—å —Ü–∏—Ñ—Ä">
          <input class="set-radio" type="radio" name="numset" id="num-easy" value="easy" checked>
          <label class="set-btn" for="num-easy">–õ—ë–≥–∫–∏–π</label>

          <input class="set-radio" type="radio" name="numset" id="num-medium" value="medium">
          <label class="set-btn" for="num-medium">–°—Ä–µ–¥–Ω–∏–π</label>

          <input class="set-radio" type="radio" name="numset" id="num-hard" value="hard">
          <label class="set-btn" for="num-hard">–°–ª–æ–∂–Ω—ã–π</label>
        </div>
      </div>

      <div class="pill select-pill">
        <div>–ì–æ–ª–æ—Å:</div>
        <select id="voiceSelect" aria-label="–í—ã–±–æ—Ä –≥–æ–ª–æ—Å–∞"></select>
      </div>

      <span class="pill toggle-pill" id="soundModeWrap">
        <label class="toggle-label">
          <input type="checkbox" id="soundMode" />
          –ì–æ–≤–æ—Ä–∏—Ç—å –∑–≤—É–∫ (–º, —Å), –∞ –Ω–µ "—ç–º/—ç—Å"
        </label>
      </span>
    </div>

    <div class="row">
      <button id="start">–°—Ç–∞—Ä—Ç / –ü–æ–≤—Ç–æ—Ä–∏</button>
      <button class="secondary" id="next">–°–ª–µ–¥—É—é—â–∞—è</button>
      <button class="secondary" id="reset">–°–±—Ä–æ—Å</button>
    </div>

    <div class="status" id="status">–ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª</div>
    
    <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ -->
    <div class="history" id="history"></div>

    <div class="hint">
      –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞: <span id="hintKeyboard">–≤–∫–ª—é—á–∏ —Ä—É—Å—Å–∫–∏–π —Ä–∞—Å–∫–ª–∞–¥</span>. –ü—Ä–æ–±–µ–ª = –ø–æ–≤—Ç–æ—Ä–∏—Ç—å.
      –¢—Ä–µ–Ω–∏—Ä—É–µ–º: <span class="kbd" id="hintLetters">–ê –û –£ –ú –° –¢ –ù –ö –õ –†</span>
    </div>

    <div class="grid" id="grid"></div>
    <div class="keypad" id="keypad" hidden></div>
  </div>

<script>
  const SETS = {
    easy: ["–ê","–û","–£","–ú","–°","–¢","–ù","–ö","–õ","–†"],
    vowels: ["–ê","–û","–£","–´","–≠","–Ø","–Å","–ï","–Æ","–ò"],
    all: "–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø".split("")
  };
  const NUM_SETS = {
    easy: { min: 1, max: 10 },
    medium: { min: 1, max: 30 },
    hard: { min: 1, max: 50 }
  };

  // ‚Äú–ó–≤—É–∫–∏‚Äù (—á—Ç–æ–±—ã —Ä–µ–±—ë–Ω–æ–∫ —Å–ª—ã—à–∞–ª –ú = ‚Äú–º‚Äù, –° = ‚Äú—Å‚Äù, –∞ –Ω–µ ‚Äú—ç–º/—ç—Å‚Äù)
  // –î–ª—è –≥–ª–∞—Å–Ω—ã—Ö –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å.
  const SOUND = {
    "–ë":"–±","–í":"–≤","–ì":"–≥","–î":"–¥","–ñ":"–∂","–ó":"–∑","–ô":"–π","–ö":"–∫","–õ":"–ª","–ú":"–º","–ù":"–Ω","–ü":"–ø","–†":"—Ä","–°":"—Å","–¢":"—Ç","–§":"—Ñ","–•":"—Ö","–¶":"—Ü","–ß":"—á","–®":"—à","–©":"—â"
  };

  const NUMBER_WORDS = {
    1: "–æ–¥–∏–Ω",
    2: "–¥–≤–∞",
    3: "—Ç—Ä–∏",
    4: "—á–µ—Ç—ã—Ä–µ",
    5: "–ø—è—Ç—å",
    6: "—à–µ—Å—Ç—å",
    7: "—Å–µ–º—å",
    8: "–≤–æ—Å–µ–º—å",
    9: "–¥–µ–≤—è—Ç—å",
    10: "–¥–µ—Å—è—Ç—å",
    11: "–æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å",
    12: "–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç—å",
    13: "—Ç—Ä–∏–Ω–∞–¥—Ü–∞—Ç—å",
    14: "—á–µ—Ç—ã—Ä–Ω–∞–¥—Ü–∞—Ç—å",
    15: "–ø—è—Ç–Ω–∞–¥—Ü–∞—Ç—å",
    16: "—à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—å",
    17: "—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å",
    18: "–≤–æ—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å",
    19: "–¥–µ–≤—è—Ç–Ω–∞–¥—Ü–∞—Ç—å",
    20: "–¥–≤–∞–¥—Ü–∞—Ç—å",
    30: "—Ç—Ä–∏–¥—Ü–∞—Ç—å",
    40: "—Å–æ—Ä–æ–∫",
    50: "–ø—è—Ç—å–¥–µ—Å—è—Ç"
  };

  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –±—É–∫–≤—É –¥–ª—è –æ–∑–≤—É—á–∫–∏ (—É—á–∏—Ç—ã–≤–∞–µ—Ç ¬´–∑–≤—É–∫¬ª —Ä–µ–∂–∏–º –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è)
  function spokenLetter(letter) {
    if (!letter) return "";
    if (SOUND[letter]) return SOUND[letter];
    // –î–ª—è –±—É–∫–≤—ã –û –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª–∞–≤–Ω—É—é —Ñ–æ—Ä–º—É, —á—Ç–æ–±—ã TTS –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞–ª –µ—ë –∫–∞–∫ –Ω–∞–∑–≤–∞–Ω–∏–µ –±—É–∫–≤—ã.
    if (letter === "–û") return "–û";
    return letter.toLowerCase();
  }

  function spokenNumber(value) {
    const num = Number.parseInt(value, 10);
    if (!Number.isFinite(num)) return "";
    if (NUMBER_WORDS[num]) return NUMBER_WORDS[num];
    if (num < 20) return NUMBER_WORDS[num] || String(num);
    const tens = Math.floor(num / 10) * 10;
    const ones = num % 10;
    if (!NUMBER_WORDS[tens]) return String(num);
    if (ones === 0) return NUMBER_WORDS[tens];
    return `${NUMBER_WORDS[tens]} ${NUMBER_WORDS[ones] || String(ones)}`;
  }

  let mode = "letters";
  let letters = SETS.easy.slice();
  let numberSet = "easy";
  let numberInput = "";
  let current = null;
  let score = 0;
  let mistakes = 0;
  let streak = 0;
  let bestStreak = 0;
  let history = [];
  let soundEnabled = true;

  const elTarget = document.getElementById("target");
  const elStatus = document.getElementById("status");
  const elScore = document.getElementById("score");
  const elMistakes = document.getElementById("mistakes");
  const elStreak = document.getElementById("streak");
  const elAccuracy = document.getElementById("accuracy");
  const elProgressBar = document.getElementById("progressBar");
  const elHistory = document.getElementById("history");
  const elGrid = document.getElementById("grid");
  const elSetToggle = document.getElementById("setToggle");
  const elModeToggle = document.getElementById("modeToggle");
  const elNumberToggle = document.getElementById("numberToggle");
  const elLetterSetWrap = document.getElementById("letterSetWrap");
  const elNumberSetWrap = document.getElementById("numberSetWrap");
  const elNumberInput = document.getElementById("numberInput");
  const elNumberInputWrap = document.getElementById("numberInputWrap");
  const elKeypad = document.getElementById("keypad");
  const elSoundMode = document.getElementById("soundMode");
  const elSoundModeWrap = document.getElementById("soundModeWrap");
  const elHintKeyboard = document.getElementById("hintKeyboard");
  const elHintLetters = document.getElementById("hintLetters");
  const elThemeToggle = document.getElementById("themeToggle");
  const elSoundToggle = document.getElementById("soundToggle");
  const elAchievements = document.getElementById("achievements");
  const elVoiceSelect = document.getElementById("voiceSelect");

  // ---- –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã ----
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  
  function playSound(frequency, duration, type = 'sine') {
    if (!soundEnabled) return;
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = frequency;
    oscillator.type = type;
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + duration);
  }
  
  function playSuccessSound() {
    playSound(523.25, 0.1); // C5
    setTimeout(() => playSound(659.25, 0.1), 100); // E5
    setTimeout(() => playSound(783.99, 0.15), 200); // G5
  }
  
  function playErrorSound() {
    playSound(200, 0.2, 'sawtooth');
  }
  
  function playAchievementSound() {
    playSound(523.25, 0.1);
    setTimeout(() => playSound(659.25, 0.1), 80);
    setTimeout(() => playSound(783.99, 0.1), 160);
    setTimeout(() => playSound(1046.50, 0.2), 240); // C6
  }

  // ---- Speech (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è) ----
  let cachedRuVoice = null;
  let availableVoices = [];
  let isSpeaking = false;
  let speechQueue = [];

  function isRuVoice(voice) {
    return (voice.lang || "").toLowerCase().startsWith("ru");
  }

  function voiceScore(voice) {
    const name = (voice.name || "").toLowerCase();
    const lang = (voice.lang || "").toLowerCase();
    let score = 0;

    if (lang.startsWith("ru")) score += 50;
    if (name.includes("google")) score += 30;
    if (name.includes("yandex")) score += 25;
    if (name.includes("irina")) score += 20;
    if (name.includes("pavel")) score += 18;
    if (name.includes("dmitry")) score += 12;
    if (name.includes("elena")) score += 12;
    if (name.includes("neural") || name.includes("natural")) score += 20;
    if (name.includes("premium")) score += 10;
    if (voice.default) score += 5;

    return score;
  }

  function pickBestVoice(voices) {
    if (!voices.length) return null;
    let best = voices[0];
    let bestScore = voiceScore(best);
    for (let i = 1; i < voices.length; i++) {
      const score = voiceScore(voices[i]);
      if (score > bestScore) {
        best = voices[i];
        bestScore = score;
      }
    }
    return best;
  }

  function loadVoices() {
    const voices = speechSynthesis.getVoices() || [];
    availableVoices = voices.slice();

    if (!voices.length) {
      elVoiceSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤...</option>';
      elVoiceSelect.disabled = true;
      cachedRuVoice = null;
      return;
    }

    elVoiceSelect.disabled = false;
    elVoiceSelect.innerHTML = "";

    const ruVoices = voices.filter(isRuVoice);
    const otherVoices = voices.filter(voice => !isRuVoice(voice));

    const addOptions = (parent, list) => {
      list.forEach(voice => {
        const opt = document.createElement("option");
        opt.value = voice.name;
        opt.textContent = `${voice.name}${voice.lang ? " (" + voice.lang + ")" : ""}`;
        parent.appendChild(opt);
      });
    };

    if (ruVoices.length && otherVoices.length) {
      const ruGroup = document.createElement("optgroup");
      ruGroup.label = "–†—É—Å—Å–∫–∏–µ";
      addOptions(ruGroup, ruVoices);
      elVoiceSelect.appendChild(ruGroup);

      const otherGroup = document.createElement("optgroup");
      otherGroup.label = "–î—Ä—É–≥–∏–µ";
      addOptions(otherGroup, otherVoices);
      elVoiceSelect.appendChild(otherGroup);
    } else {
      addOptions(elVoiceSelect, voices);
    }

    const savedName = localStorage.getItem("voice");
    let selected = null;
    if (savedName) {
      selected = voices.find(v => v.name === savedName) || null;
    }

    if (!selected) {
      selected = pickBestVoice(ruVoices.length ? ruVoices : voices);
    }

    cachedRuVoice = selected || null;
    if (cachedRuVoice) {
      elVoiceSelect.value = cachedRuVoice.name;
    }
  }
  
  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;

  function say(text, priority = false) {
    if (priority) {
      // –ü—Ä–µ—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –æ–∑–≤—É—á–∫—É –¥–ª—è —Å—Ä–æ—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      speechSynthesis.cancel();
      speechQueue = [];
      isSpeaking = false;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
    speechQueue.push(text);
    
    // –ï—Å–ª–∏ –Ω–µ –≥–æ–≤–æ—Ä–∏–º —Å–µ–π—á–∞—Å, –Ω–∞—á–∏–Ω–∞–µ–º
    if (!isSpeaking) {
      processQueue();
    }
  }

  function spokenValue(value, useSound) {
    if (mode === "numbers") return spokenNumber(value);
    return useSound ? spokenLetter(value) : value;
  }

  function sayPhraseAndLetter(prefix, value, useSound, priority = false) {
    if (priority) {
      say(prefix, true);
    } else {
      say(prefix);
    }
    const spoken = spokenValue(value, useSound);
    if (spoken) {
      say(spoken);
    }
  }

  function sayPrompt(value, useSound, priority = false) {
    const prefix = mode === "numbers" ? "—Ü–∏—Ñ—Ä–∞" : `–ù–∞–∂–º–∏ ${useSound ? "–∑–≤—É–∫" : "–±—É–∫–≤—É"}`;
    sayPhraseAndLetter(prefix, value, useSound, priority);
  }

  function sayCorrection(gotValue, needValue, useSound) {
    const noun = mode === "numbers" ? "—Ü–∏—Ñ—Ä–∞" : (useSound ? "–∑–≤—É–∫" : "–±—É–∫–≤–∞");
    sayPhraseAndLetter(`–≠—Ç–æ ${noun}`, gotValue, useSound);
    sayPhraseAndLetter(`–ù—É–∂–Ω–∞ ${noun}`, needValue, useSound);
  }
  
  function processQueue() {
    if (speechQueue.length === 0) {
      isSpeaking = false;
      return;
    }
    
    isSpeaking = true;
    const text = speechQueue.shift();
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –æ–∑–≤—É—á–∫—É
    speechSynthesis.cancel();
    
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π –æ–∑–≤—É—á–∫–æ–π –¥–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏
    setTimeout(() => {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = (cachedRuVoice && cachedRuVoice.lang) ? cachedRuVoice.lang : "ru-RU";
      u.rate = 0.85; // –ú–µ–¥–ª–µ–Ω–Ω–µ–µ –¥–ª—è –ª—É—á—à–µ–π —á–µ—Ç–∫–æ—Å—Ç–∏
      u.pitch = 1.1;
      u.volume = 1.0;
      
      if (cachedRuVoice) {
        u.voice = cachedRuVoice;
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      u.onend = () => {
        isSpeaking = false;
        // –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ñ—Ä–∞–∑–∞–º–∏
        setTimeout(() => processQueue(), 300);
      };
      
      u.onerror = (e) => {
        console.error('Speech error:', e);
        isSpeaking = false;
        setTimeout(() => processQueue(), 100);
      };
      
      speechSynthesis.speak(u);
    }, 150);
  }

  function setStatus(text) {
    elStatus.textContent = text;
  }

  function updateCounters() {
    elScore.textContent = String(score);
    elMistakes.textContent = String(mistakes);
    elStreak.textContent = String(streak);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–Ω–æ—Å—Ç—å
    const total = score + mistakes;
    const accuracy = total > 0 ? Math.round((score / total) * 100) : 100;
    elAccuracy.textContent = accuracy + '%';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä (–¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è)
    const nextMilestone = streak < 5 ? 5 : streak < 10 ? 10 : streak < 20 ? 20 : 50;
    const progress = Math.min((streak / nextMilestone) * 100, 100);
    elProgressBar.style.width = progress + '%';
    elProgressBar.textContent = `${streak}/${nextMilestone}`;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    checkAchievements();
  }
  
  function checkAchievements() {
    const achievements = elAchievements.querySelectorAll('.achievement');
    achievements.forEach(achievement => {
      const level = parseInt(achievement.dataset.level);
      if (streak >= level && !achievement.classList.contains('unlocked')) {
        achievement.classList.add('unlocked');
        playAchievementSound();
        createConfetti();
        
        const messages = {
          5: "üéâ –û—Ç–ª–∏—á–Ω–æ! 5 –ø–æ–¥—Ä—è–¥!",
          10: "üåü –°—É–ø–µ—Ä! 10 –ø–æ–¥—Ä—è–¥!",
          20: "‚ú® –§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞! 20 –ø–æ–¥—Ä—è–¥!",
          50: "üèÜ –ß–µ–º–ø–∏–æ–Ω! 50 –ø–æ–¥—Ä—è–¥!"
        };
        
        if (messages[level]) {
          setTimeout(() => {
            setStatus(messages[level]);
            say(messages[level].replace(/[üéâüåü‚ú®üèÜ]/g, ''));
          }, 300);
        }
      }
    });
  }
  
  function createConfetti() {
    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7', '#a29bfe'];
    for (let i = 0; i < 30; i++) {
      setTimeout(() => {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * window.innerWidth + 'px';
        confetti.style.top = '0px';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDuration = (1 + Math.random()) + 's';
        confetti.style.animationDelay = Math.random() * 0.5 + 's';
        document.body.appendChild(confetti);
        
        setTimeout(() => confetti.remove(), 2500);
      }, i * 30);
    }
  }
  
  function updateHistory(letter, isCorrect) {
    history.unshift({ letter, isCorrect });
    if (history.length > 7) history.pop();
    
    elHistory.innerHTML = '';
    history.forEach(item => {
      const div = document.createElement('div');
      div.className = `history-item ${item.isCorrect ? 'correct' : 'incorrect'}`;
      div.textContent = item.letter;
      elHistory.appendChild(div);
    });
  }

  function updateHint() {
    if (mode === "numbers") {
      const range = NUM_SETS[numberSet];
      elHintLetters.textContent = `${range.min}-${range.max}`;
      elHintKeyboard.textContent = "—Ü–∏—Ñ—Ä—ã –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ";
      return;
    }
    elHintLetters.textContent = letters.join(" ");
    elHintKeyboard.textContent = "–≤–∫–ª—é—á–∏ —Ä—É—Å—Å–∫–∏–π —Ä–∞—Å–∫–ª–∞–¥";
  }

  function updateNumberInput() {
    elNumberInput.textContent = numberInput || "‚Äî";
  }

  function setNumberInput(value) {
    numberInput = value;
    updateNumberInput();
  }

  function addDigit(digit) {
    if (numberInput.length >= 2) return;
    if (numberInput === "0") numberInput = "";
    numberInput += digit;
    updateNumberInput();
    autoSubmitIfMatch();
  }

  function backspaceNumber() {
    if (!numberInput) return;
    numberInput = numberInput.slice(0, -1);
    updateNumberInput();
  }

  function submitNumber() {
    if (!numberInput) return;
    handleAnswer(numberInput);
  }

  function autoSubmitIfMatch() {
    if (mode !== "numbers" || !current) return;
    if (numberInput === current) handleAnswer(numberInput);
  }

  function buildKeypad() {
    elKeypad.innerHTML = "";
    const keys = ["1","2","3","4","5","6","7","8","9","backspace","0","ok"];
    keys.forEach(key => {
      const d = document.createElement("div");
      d.className = "tile";
      if (key === "backspace") {
        d.textContent = "‚å´";
        d.dataset.action = "backspace";
      } else if (key === "ok") {
        d.textContent = "OK";
        d.dataset.action = "ok";
      } else {
        d.textContent = key;
        d.dataset.digit = key;
      }
      d.addEventListener("click", () => {
        if (d.dataset.digit) addDigit(d.dataset.digit);
        if (d.dataset.action === "backspace") backspaceNumber();
        if (d.dataset.action === "ok") submitNumber();
      });
      elKeypad.appendChild(d);
    });
  }

  function buildGrid() {
    elGrid.innerHTML = "";
    letters.forEach(L => {
      const d = document.createElement("div");
      d.className = "tile";
      d.textContent = L;
      d.dataset.letter = L;
      d.addEventListener("click", () => handleAnswer(L, d));
      elGrid.appendChild(d);
    });
    updateHint();
  }

  function applyMode(nextMode) {
    mode = nextMode;
    const isNumbers = mode === "numbers";

    elLetterSetWrap.hidden = isNumbers;
    elNumberSetWrap.hidden = !isNumbers;
    elSoundModeWrap.hidden = isNumbers;
    elGrid.hidden = isNumbers;
    elKeypad.hidden = !isNumbers;
    elNumberInputWrap.hidden = !isNumbers;

    if (isNumbers) {
      buildKeypad();
      setNumberInput("");
    } else {
      buildGrid();
    }

    updateHint();
    clearTileMarks();
    current = null;
    elTarget.textContent = "‚Äî";
    setStatus("–ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª");
  }

  function applyNumberSet(value) {
    numberSet = value;
    updateHint();
    if (current && mode === "numbers") pick();
  }

  function pick() {
    if (mode === "numbers") {
      const range = NUM_SETS[numberSet];
      const value = Math.floor(Math.random() * (range.max - range.min + 1)) + range.min;
      current = String(value);
    } else {
      current = letters[Math.floor(Math.random() * letters.length)];
    }
    elTarget.textContent = current;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è –±—É–∫–≤—ã/—á–∏—Å–ª–∞
    elTarget.classList.remove('bounce', 'shake');
    setTimeout(() => elTarget.classList.add('bounce'), 10);

    const useSound = mode === "letters" ? elSoundMode.checked : false;
    sayPrompt(current, useSound);

    setStatus(mode === "numbers" ? "–°–ª—É—à–∞–π –∏ –Ω–∞–±–∏—Ä–∞–π üôÇ" : "–°–ª—É—à–∞–π –∏ –≤—ã–±–∏—Ä–∞–π üôÇ");
    if (mode === "numbers") setNumberInput("");
    clearTileMarks();
  }

  function clearTileMarks() {
    [...document.querySelectorAll(".tile")].forEach(t => t.classList.remove("good","bad"));
  }

  function flashTile(tile, ok) {
    tile.classList.remove("good","bad");
    tile.classList.add(ok ? "good" : "bad");
    setTimeout(() => tile.classList.remove("good","bad"), 350);
  }

  function handleAnswer(pressed, tileEl=null) {
    if (!current) return;

    let pressedLabel = "";
    let ok = false;
    if (mode === "numbers") {
      const pressedNum = Number.parseInt(pressed, 10);
      if (!Number.isFinite(pressedNum)) return;
      pressedLabel = String(pressedNum);
      ok = pressedNum === Number.parseInt(current, 10);
    } else {
      pressedLabel = (pressed || "").toUpperCase();
      ok = (pressedLabel === current);
    }

    if (ok) {
      score += 1;
      streak += 1;
      if (streak > bestStreak) bestStreak = streak;
      
      updateCounters();
      updateHistory(current, true);
      
      playSuccessSound();
      
      const praises = [
        "‚úÖ –£—Ä–∞! –ü—Ä–∞–≤–∏–ª—å–Ω–æ!",
        "üéØ –¢–æ—á–Ω–æ! –ú–æ–ª–æ–¥–µ—Ü!",
        "‚≠ê –û—Ç–ª–∏—á–Ω–æ! –°—É–ø–µ—Ä!",
        "üëç –ë—Ä–∞–≤–æ! –ó–¥–æ—Ä–æ–≤–æ!",
        "üåü –£–º–Ω–∏—Ü–∞! –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!"
      ];
      const praise = praises[Math.floor(Math.random() * praises.length)];
      setStatus(praise);
      say(praise.replace(/[‚úÖüéØ‚≠êüëçüåü]/g, ''));
      
      if (tileEl) flashTile(tileEl, true);
      
      // –ê–Ω–∏–º–∞—Ü–∏—è –±—É–∫–≤—ã –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
      elTarget.classList.remove('bounce', 'shake');
      elTarget.classList.add('bounce');

      // —Å–ª–µ–¥—É—é—â–∞—è –±—É–∫–≤–∞
      setTimeout(pick, 650);
    } else {
      mistakes += 1;
      streak = 0;
      updateCounters();
      updateHistory(pressedLabel, false);
      
      playErrorSound();
      
      // –ê–Ω–∏–º–∞—Ü–∏—è –≤—Å—Ç—Ä—è—Ö–∏–≤–∞–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
      elTarget.classList.remove('bounce', 'shake');
      elTarget.classList.add('shake');

      if (mode === "numbers") {
        setStatus(`‚ùå –≠—Ç–æ ¬´${pressedLabel}¬ª. –°–ª—É—à–∞–π –µ—â—ë —Ä–∞–∑!`);
        sayCorrection(pressedLabel, current, false);
      } else if (pressedLabel.length === 1) {
        setStatus(`‚ùå –≠—Ç–æ ¬´${pressedLabel}¬ª. –°–ª—É—à–∞–π –µ—â—ë —Ä–∞–∑!`);
        const useSound = elSoundMode.checked;
        sayCorrection(pressedLabel, current, useSound);
      }

      if (tileEl) flashTile(tileEl, false);
    }

    if (mode === "numbers") setNumberInput("");
  }

  // ---- UI handlers ----
  document.getElementById("start").addEventListener("click", () => {
    // –ø–µ—Ä–≤—ã–π –∫–ª–∏–∫ ‚Äú—Ä–∞–∑—Ä–µ—à–∞–µ—Ç‚Äù –æ–∑–≤—É—á–∫—É
    if (!current) {
      if (mode === "numbers") {
        buildKeypad();
      } else {
        buildGrid();
      }
      pick();
    } else {
      const useSound = mode === "letters" ? elSoundMode.checked : false;
      sayPrompt(current, useSound);
    }
  });

  document.getElementById("next").addEventListener("click", () => {
    if (!current) {
      if (mode === "numbers") {
        buildKeypad();
      } else {
        buildGrid();
      }
    }
    pick();
  });

  document.getElementById("reset").addEventListener("click", () => {
    score = 0; 
    mistakes = 0; 
    streak = 0;
    bestStreak = 0;
    history = [];
    
    updateCounters();
    elHistory.innerHTML = '';
    elProgressBar.style.width = '0%';
    elProgressBar.textContent = '0%';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    elAchievements.querySelectorAll('.achievement').forEach(a => a.classList.remove('unlocked'));
    
    current = null;
    elTarget.textContent = "‚Äî";
    setStatus("–ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª");
    clearTileMarks();
    setNumberInput("");
  });

  function applySet(value) {
    letters = SETS[value].slice();
    if (mode === "letters") {
      buildGrid();
      if (current) pick();
    } else {
      updateHint();
    }
  }

  elSetToggle.addEventListener('change', (e) => {
    const input = e.target.closest('input[type="radio"][name="set"]');
    if (!input) return;
    applySet(input.value);
  });

  elModeToggle.addEventListener('change', (e) => {
    const input = e.target.closest('input[type="radio"][name="mode"]');
    if (!input) return;
    applyMode(input.value);
  });

  elNumberToggle.addEventListener('change', (e) => {
    const input = e.target.closest('input[type="radio"][name="numset"]');
    if (!input) return;
    applyNumberSet(input.value);
  });

  elSoundMode.addEventListener("change", () => {
    if (current) {
      const useSound = mode === "letters" ? elSoundMode.checked : false;
      sayPrompt(current, useSound);
    }
  });

  elVoiceSelect.addEventListener("change", () => {
    const selectedName = elVoiceSelect.value;
    const voice = availableVoices.find(v => v.name === selectedName) || null;
    cachedRuVoice = voice;
    if (selectedName) {
      localStorage.setItem("voice", selectedName);
    }
  });

  // –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ + –ø—Ä–æ–±–µ–ª –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞
  window.addEventListener("keydown", (e) => {
    if (e.code === "Space") {
      e.preventDefault();
      if (current) {
        const useSound = mode === "letters" ? elSoundMode.checked : false;
        sayPrompt(current, useSound);
      }
      return;
    }
    if (!current) return;

    if (mode === "numbers") {
      if (e.key >= "0" && e.key <= "9") {
        addDigit(e.key);
        return;
      }
      if (e.key === "Backspace") {
        backspaceNumber();
        return;
      }
      if (e.key === "Enter") {
        submitNumber();
        return;
      }
      return;
    }

    const pressed = (e.key || "").toUpperCase();
    if (pressed.length !== 1) return;

    // –ø–æ–¥—Å–≤–µ—Ç–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –ø–ª–∏—Ç–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å
    const tile = [...document.querySelectorAll(".tile")].find(t => t.dataset.letter === pressed) || null;
    handleAnswer(pressed, tile);
  });
  
  // –¢–µ–º–Ω–∞—è —Ç–µ–º–∞
  elThemeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-theme');
    elThemeToggle.textContent = document.body.classList.contains('dark-theme') ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
  });
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É
  if (localStorage.getItem('theme') === 'dark') {
    document.body.classList.add('dark-theme');
    elThemeToggle.textContent = '‚òÄÔ∏è';
  }
  
  // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∑–≤—É–∫–∞
  elSoundToggle.addEventListener('click', () => {
    soundEnabled = !soundEnabled;
    elSoundToggle.classList.toggle('muted');
    elSoundToggle.textContent = soundEnabled ? 'üîä' : 'üîá';
    localStorage.setItem('sound', soundEnabled ? 'on' : 'off');
  });
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∑–≤—É–∫–∞
  if (localStorage.getItem('sound') === 'off') {
    soundEnabled = false;
    elSoundToggle.classList.add('muted');
    elSoundToggle.textContent = 'üîá';
  }

  // –Ω–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
  applyMode(mode);
  updateCounters();
</script>
</body>
</html>

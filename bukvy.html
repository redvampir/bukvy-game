<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ë—É–∫–≤–µ–Ω–Ω–∞—è –∏–≥—Ä–∞</title>
  <style>
    body { font-family: system-ui, Arial; text-align:center; margin:0; padding:24px; background:#fff7e6; transition: background 0.3s ease; }
    body.dark-theme { background:#1a1a2e; color:#eee; }
    
    .card { max-width:860px; margin:0 auto; background:white; border-radius:18px; padding:18px; box-shadow:0 10px 25px rgba(0,0,0,.08); }
    .dark-theme .card { background:#16213e; box-shadow:0 10px 25px rgba(0,0,0,.3); }
    
    h1 { margin: 8px 0 10px; }
    .big { font-size:92px; margin:10px 0 4px; transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
    .big.bounce { animation: bounce 0.5s ease; }
    .big.shake { animation: shake 0.4s ease; }
    
    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    
    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(500px) rotate(720deg); opacity: 0; }
    }
    
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: #f0f;
      z-index: 9999;
      animation: confetti 2s ease-out forwards;
      pointer-events: none;
    }
    
    .hint { font-size:16px; opacity:.85; margin: 6px 0; }
    .dark-theme .hint { opacity:.7; }
    
    .status { margin-top:10px; font-size:20px; min-height: 28px; font-weight: 500; }
    
    button { font-size:18px; padding:12px 16px; border:0; border-radius:12px; background:#ff7a00; color:white; cursor:pointer; transition: all 0.2s ease; }
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255,122,0,0.3); }
    button.secondary { background:#ffd7b0; color:#4a2a00; }
    button.secondary:hover { background:#ffcda0; }
    button:active { transform: scale(0.98); }
    .row { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:10px; }

    .grid { display:grid; grid-template-columns: repeat(5, minmax(64px, 1fr)); gap:12px; margin-top:14px; }
    @media (max-width: 600px) {
      .grid { grid-template-columns: repeat(3, minmax(80px, 1fr)); gap:16px; }
      .tile { font-size:48px; padding:24px 0; }
    }
    
    .tile {
      font-size:42px; padding:18px 0; border-radius:16px; border:2px solid #f2f2f2;
      background:#fafafa; cursor:pointer; user-select:none;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
    }
    .dark-theme .tile { background:#0f3460; border-color:#1a4d7a; color:#fff; }
    .tile:hover { transform: scale(1.05); }
    .tile:active { transform: scale(0.98); }
    .tile.good { background:#d9fbe1; border-color:#56c271; animation: pulse 0.3s ease; }
    .tile.bad { background:#ffe0e0; border-color:#ff6b6b; animation: shake 0.3s ease; }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .dark-theme .tile.good { background:#1e4d2b; border-color:#56c271; }
    .dark-theme .tile.bad { background:#4d1e1e; border-color:#ff6b6b; }

    .bar { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; align-items:center; margin-top:10px; }
    .pill { background:#f2f2f2; padding:8px 12px; border-radius:999px; font-size:14px; transition: background 0.2s ease; }
    .dark-theme .pill { background:#0f3460; }
    select, input[type="checkbox"] { transform: scale(1.1); }
    .dark-theme select { background:#0f3460; color:#fff; border-color:#1a4d7a; }
    .kbd { background:#f2f2f2; padding:4px 8px; border-radius:10px; font-weight:700; }
    .dark-theme .kbd { background:#0f3460; }
    
    /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
    .progress-container { margin: 12px 0; background: #e0e0e0; border-radius: 999px; height: 24px; overflow: hidden; }
    .dark-theme .progress-container { background: #0f3460; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, #56c271, #4caf50); transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; }
    
    /* –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è */
    .achievements { display: flex; gap: 8px; justify-content: center; margin: 10px 0; flex-wrap: wrap; }
    .achievement { font-size: 32px; opacity: 0.3; transition: all 0.3s ease; filter: grayscale(100%); }
    .achievement.unlocked { opacity: 1; filter: grayscale(0%); animation: pop 0.5s ease; }
    
    @keyframes pop {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }
    
    /* –ò—Å—Ç–æ—Ä–∏—è */
    .history { margin: 12px 0; display: flex; gap: 6px; justify-content: center; flex-wrap: wrap; }
    .history-item { font-size: 24px; width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 2px solid #f2f2f2; }
    .dark-theme .history-item { border-color: #1a4d7a; background: #0f3460; }
    .history-item.correct { background: #d9fbe1; border-color: #56c271; }
    .history-item.incorrect { background: #ffe0e0; border-color: #ff6b6b; }
    .dark-theme .history-item.correct { background: #1e4d2b; }
    .dark-theme .history-item.incorrect { background: #4d1e1e; }
    
    /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã */
    .theme-toggle { position: fixed; top: 20px; right: 20px; background: #ff7a00; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: all 0.2s ease; z-index: 1000; }
    .theme-toggle:hover { transform: scale(1.1); }
    .dark-theme .theme-toggle { background: #ffd700; }
    
    /* –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä */
    .sound-toggle { position: fixed; top: 80px; right: 20px; background: #4caf50; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: all 0.2s ease; z-index: 1000; }
    .sound-toggle:hover { transform: scale(1.1); }
    .sound-toggle.muted { background: #999; }
  </style>
</head>
<body>
  <button class="theme-toggle" id="themeToggle">üåô</button>
  <button class="sound-toggle" id="soundToggle">üîä</button>
  
  <div class="card">
    <h1>–ù–∞–∂–º–∏ –±—É–∫–≤—É üéà</h1>
    <div class="hint">–ò–≥—Ä–∞ –≥–æ–≤–æ—Ä–∏—Ç –±—É–∫–≤—É. –†–µ–±—ë–Ω–æ–∫ –Ω–∞–∂–∏–º–∞–µ—Ç –µ—ë –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –∏–ª–∏ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ.</div>

    <div class="big" id="target">‚Äî</div>
    
    <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
    <div class="achievements" id="achievements">
      <span class="achievement" data-level="5" title="5 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–¥—Ä—è–¥">‚≠ê</span>
      <span class="achievement" data-level="10" title="10 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–¥—Ä—è–¥">üåü</span>
      <span class="achievement" data-level="20" title="20 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–¥—Ä—è–¥">‚ú®</span>
      <span class="achievement" data-level="50" title="50 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–¥—Ä—è–¥">üèÜ</span>
    </div>
    
    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
    <div class="progress-container">
      <div class="progress-bar" id="progressBar" style="width: 0%;">0%</div>
    </div>

    <div class="bar">
      <span class="pill">–û—á–∫–∏: <b id="score">0</b></span>
      <span class="pill">–û—à–∏–±–∫–∏: <b id="mistakes">0</b></span>
      <span class="pill">–ü–æ–¥—Ä—è–¥: <b id="streak">0</b> üî•</span>
      <span class="pill">–¢–æ—á–Ω–æ—Å—Ç—å: <b id="accuracy">100%</b></span>

      <span class="pill">
        –ù–∞–±–æ—Ä:
        <select id="set">
          <option value="easy">–õ—ë–≥–∫–∏–π (–ê –û –£ –ú –° –¢ –ù –ö –õ –†)</option>
          <option value="vowels">–¢–æ–ª—å–∫–æ –≥–ª–∞—Å–Ω—ã–µ (–ê –û –£ –´ –≠ –Ø –Å –ï –Æ –ò)</option>
          <option value="all">–ü–æ—á—Ç–∏ –≤—Å–µ (–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø)</option>
        </select>
      </span>

      <span class="pill">
        <label>
          <input type="checkbox" id="soundMode" />
          –ì–æ–≤–æ—Ä–∏—Ç—å –∑–≤—É–∫ (–º, —Å), –∞ –Ω–µ ‚Äú—ç–º/—ç—Å‚Äù
        </label>
      </span>
    </div>

    <div class="row">
      <button id="start">–°—Ç–∞—Ä—Ç / –ü–æ–≤—Ç–æ—Ä–∏</button>
      <button class="secondary" id="next">–°–ª–µ–¥—É—é—â–∞—è</button>
      <button class="secondary" id="reset">–°–±—Ä–æ—Å</button>
    </div>

    <div class="status" id="status">–ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª</div>
    
    <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ -->
    <div class="history" id="history"></div>

    <div class="hint">
      –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞: –≤–∫–ª—é—á–∏ —Ä—É—Å—Å–∫–∏–π —Ä–∞—Å–∫–ª–∞–¥. –ü—Ä–æ–±–µ–ª = –ø–æ–≤—Ç–æ—Ä–∏—Ç—å.
      –¢—Ä–µ–Ω–∏—Ä—É–µ–º: <span class="kbd" id="hintLetters">–ê –û –£ –ú –° –¢ –ù –ö –õ –†</span>
    </div>

    <div class="grid" id="grid"></div>
  </div>

<script>
  const SETS = {
    easy: ["–ê","–û","–£","–ú","–°","–¢","–ù","–ö","–õ","–†"],
    vowels: ["–ê","–û","–£","–´","–≠","–Ø","–Å","–ï","–Æ","–ò"],
    all: "–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø".split("")
  };

  // ‚Äú–ó–≤—É–∫–∏‚Äù (—á—Ç–æ–±—ã —Ä–µ–±—ë–Ω–æ–∫ —Å–ª—ã—à–∞–ª –ú = ‚Äú–º‚Äù, –° = ‚Äú—Å‚Äù, –∞ –Ω–µ ‚Äú—ç–º/—ç—Å‚Äù)
  // –î–ª—è –≥–ª–∞—Å–Ω—ã—Ö –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å.
  const SOUND = {
    "–ë":"–±","–í":"–≤","–ì":"–≥","–î":"–¥","–ñ":"–∂","–ó":"–∑","–ô":"–π","–ö":"–∫","–õ":"–ª","–ú":"–º","–ù":"–Ω","–ü":"–ø","–†":"—Ä","–°":"—Å","–¢":"—Ç","–§":"—Ñ","–•":"—Ö","–¶":"—Ü","–ß":"—á","–®":"—à","–©":"—â"
  };

  let letters = SETS.easy.slice();
  let current = null;
  let score = 0;
  let mistakes = 0;
  let streak = 0;
  let bestStreak = 0;
  let history = [];
  let soundEnabled = true;

  const elTarget = document.getElementById("target");
  const elStatus = document.getElementById("status");
  const elScore = document.getElementById("score");
  const elMistakes = document.getElementById("mistakes");
  const elStreak = document.getElementById("streak");
  const elAccuracy = document.getElementById("accuracy");
  const elProgressBar = document.getElementById("progressBar");
  const elHistory = document.getElementById("history");
  const elGrid = document.getElementById("grid");
  const elSet = document.getElementById("set");
  const elSoundMode = document.getElementById("soundMode");
  const elHintLetters = document.getElementById("hintLetters");
  const elThemeToggle = document.getElementById("themeToggle");
  const elSoundToggle = document.getElementById("soundToggle");
  const elAchievements = document.getElementById("achievements");

  // ---- –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã ----
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  
  function playSound(frequency, duration, type = 'sine') {
    if (!soundEnabled) return;
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = frequency;
    oscillator.type = type;
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + duration);
  }
  
  function playSuccessSound() {
    playSound(523.25, 0.1); // C5
    setTimeout(() => playSound(659.25, 0.1), 100); // E5
    setTimeout(() => playSound(783.99, 0.15), 200); // G5
  }
  
  function playErrorSound() {
    playSound(200, 0.2, 'sawtooth');
  }
  
  function playAchievementSound() {
    playSound(523.25, 0.1);
    setTimeout(() => playSound(659.25, 0.1), 80);
    setTimeout(() => playSound(783.99, 0.1), 160);
    setTimeout(() => playSound(1046.50, 0.2), 240); // C6
  }

  // ---- Speech (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è) ----
  let cachedRuVoice = null;
  let isSpeaking = false;
  let speechQueue = [];

  function loadVoices() {
    const voices = speechSynthesis.getVoices();
    // –ò—â–µ–º –ª—É—á—à–∏–µ —Ä—É—Å—Å–∫–∏–µ –≥–æ–ª–æ—Å–∞ –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
    const preferredVoices = [
      'Microsoft Irina Desktop - Russian',
      'Microsoft Pavel - Russian (Russia)',
      'Google —Ä—É—Å—Å–∫–∏–π',
      'Yandex Russian',
      'ru-RU'
    ];
    
    for (let pref of preferredVoices) {
      const voice = voices.find(v => v.name.includes(pref) || v.lang.includes('ru'));
      if (voice) {
        cachedRuVoice = voice;
        break;
      }
    }
    
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –±–µ—Ä–µ–º –ª—é–±–æ–π —Ä—É—Å—Å–∫–∏–π
    if (!cachedRuVoice) {
      cachedRuVoice = voices.find(v => (v.lang || "").toLowerCase().startsWith("ru")) || null;
    }
  }
  
  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;

  function say(text, priority = false) {
    if (priority) {
      // –ü—Ä–µ—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –æ–∑–≤—É—á–∫—É –¥–ª—è —Å—Ä–æ—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      speechSynthesis.cancel();
      speechQueue = [];
      isSpeaking = false;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
    speechQueue.push(text);
    
    // –ï—Å–ª–∏ –Ω–µ –≥–æ–≤–æ—Ä–∏–º —Å–µ–π—á–∞—Å, –Ω–∞—á–∏–Ω–∞–µ–º
    if (!isSpeaking) {
      processQueue();
    }
  }
  
  function processQueue() {
    if (speechQueue.length === 0) {
      isSpeaking = false;
      return;
    }
    
    isSpeaking = true;
    const text = speechQueue.shift();
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –æ–∑–≤—É—á–∫—É
    speechSynthesis.cancel();
    
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π –æ–∑–≤—É—á–∫–æ–π –¥–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏
    setTimeout(() => {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "ru-RU";
      u.rate = 0.85; // –ú–µ–¥–ª–µ–Ω–Ω–µ–µ –¥–ª—è –ª—É—á—à–µ–π —á–µ—Ç–∫–æ—Å—Ç–∏
      u.pitch = 1.1;
      u.volume = 1.0;
      
      if (cachedRuVoice) {
        u.voice = cachedRuVoice;
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      u.onend = () => {
        isSpeaking = false;
        // –ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ñ—Ä–∞–∑–∞–º–∏
        setTimeout(() => processQueue(), 300);
      };
      
      u.onerror = (e) => {
        console.error('Speech error:', e);
        isSpeaking = false;
        setTimeout(() => processQueue(), 100);
      };
      
      speechSynthesis.speak(u);
    }, 150);
  }

  function setStatus(text) {
    elStatus.textContent = text;
  }

  function updateCounters() {
    elScore.textContent = String(score);
    elMistakes.textContent = String(mistakes);
    elStreak.textContent = String(streak);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–Ω–æ—Å—Ç—å
    const total = score + mistakes;
    const accuracy = total > 0 ? Math.round((score / total) * 100) : 100;
    elAccuracy.textContent = accuracy + '%';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä (–¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è)
    const nextMilestone = streak < 5 ? 5 : streak < 10 ? 10 : streak < 20 ? 20 : 50;
    const progress = Math.min((streak / nextMilestone) * 100, 100);
    elProgressBar.style.width = progress + '%';
    elProgressBar.textContent = `${streak}/${nextMilestone}`;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    checkAchievements();
  }
  
  function checkAchievements() {
    const achievements = elAchievements.querySelectorAll('.achievement');
    achievements.forEach(achievement => {
      const level = parseInt(achievement.dataset.level);
      if (streak >= level && !achievement.classList.contains('unlocked')) {
        achievement.classList.add('unlocked');
        playAchievementSound();
        createConfetti();
        
        const messages = {
          5: "üéâ –û—Ç–ª–∏—á–Ω–æ! 5 –ø–æ–¥—Ä—è–¥!",
          10: "üåü –°—É–ø–µ—Ä! 10 –ø–æ–¥—Ä—è–¥!",
          20: "‚ú® –§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞! 20 –ø–æ–¥—Ä—è–¥!",
          50: "üèÜ –ß–µ–º–ø–∏–æ–Ω! 50 –ø–æ–¥—Ä—è–¥!"
        };
        
        if (messages[level]) {
          setTimeout(() => {
            setStatus(messages[level]);
            say(messages[level].replace(/[üéâüåü‚ú®üèÜ]/g, ''));
          }, 300);
        }
      }
    });
  }
  
  function createConfetti() {
    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7', '#a29bfe'];
    for (let i = 0; i < 30; i++) {
      setTimeout(() => {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * window.innerWidth + 'px';
        confetti.style.top = '0px';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDuration = (1 + Math.random()) + 's';
        confetti.style.animationDelay = Math.random() * 0.5 + 's';
        document.body.appendChild(confetti);
        
        setTimeout(() => confetti.remove(), 2500);
      }, i * 30);
    }
  }
  
  function updateHistory(letter, isCorrect) {
    history.unshift({ letter, isCorrect });
    if (history.length > 7) history.pop();
    
    elHistory.innerHTML = '';
    history.forEach(item => {
      const div = document.createElement('div');
      div.className = `history-item ${item.isCorrect ? 'correct' : 'incorrect'}`;
      div.textContent = item.letter;
      elHistory.appendChild(div);
    });
  }

  function buildGrid() {
    elGrid.innerHTML = "";
    letters.forEach(L => {
      const d = document.createElement("div");
      d.className = "tile";
      d.textContent = L;
      d.dataset.letter = L;
      d.addEventListener("click", () => handleAnswer(L, d));
      elGrid.appendChild(d);
    });
    elHintLetters.textContent = letters.join(" ");
  }

  function pick() {
    current = letters[Math.floor(Math.random() * letters.length)];
    elTarget.textContent = current;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è –±—É–∫–≤—ã
    elTarget.classList.remove('bounce', 'shake');
    setTimeout(() => elTarget.classList.add('bounce'), 10);

    const useSound = elSoundMode.checked;
    const spoken = useSound ? (SOUND[current] || current.toLowerCase()) : current;
    say(`–ù–∞–∂–º–∏ ${useSound ? "–∑–≤—É–∫" : "–±—É–∫–≤—É"} ${spoken}`);

    setStatus("–°–ª—É—à–∞–π –∏ –≤—ã–±–∏—Ä–∞–π üôÇ");
    clearTileMarks();
  }

  function clearTileMarks() {
    [...document.querySelectorAll(".tile")].forEach(t => t.classList.remove("good","bad"));
  }

  function flashTile(tile, ok) {
    tile.classList.remove("good","bad");
    tile.classList.add(ok ? "good" : "bad");
    setTimeout(() => tile.classList.remove("good","bad"), 350);
  }

  function handleAnswer(pressed, tileEl=null) {
    if (!current) return;

    const pressedUp = (pressed || "").toUpperCase();
    const ok = (pressedUp === current);

    if (ok) {
      score += 1;
      streak += 1;
      if (streak > bestStreak) bestStreak = streak;
      
      updateCounters();
      updateHistory(current, true);
      
      playSuccessSound();
      
      const praises = [
        "‚úÖ –£—Ä–∞! –ü—Ä–∞–≤–∏–ª—å–Ω–æ!",
        "üéØ –¢–æ—á–Ω–æ! –ú–æ–ª–æ–¥–µ—Ü!",
        "‚≠ê –û—Ç–ª–∏—á–Ω–æ! –°—É–ø–µ—Ä!",
        "üëç –ë—Ä–∞–≤–æ! –ó–¥–æ—Ä–æ–≤–æ!",
        "üåü –£–º–Ω–∏—Ü–∞! –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!"
      ];
      const praise = praises[Math.floor(Math.random() * praises.length)];
      setStatus(praise);
      say(praise.replace(/[‚úÖüéØ‚≠êüëçüåü]/g, ''));
      
      if (tileEl) flashTile(tileEl, true);
      
      // –ê–Ω–∏–º–∞—Ü–∏—è –±—É–∫–≤—ã –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
      elTarget.classList.remove('bounce', 'shake');
      elTarget.classList.add('bounce');

      // —Å–ª–µ–¥—É—é—â–∞—è –±—É–∫–≤–∞
      setTimeout(pick, 650);
    } else {
      mistakes += 1;
      streak = 0;
      updateCounters();
      updateHistory(pressedUp, false);
      
      playErrorSound();
      
      // –ê–Ω–∏–º–∞—Ü–∏—è –≤—Å—Ç—Ä—è—Ö–∏–≤–∞–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
      elTarget.classList.remove('bounce', 'shake');
      elTarget.classList.add('shake');

      if (pressedUp.length === 1) {
        setStatus(`‚ùå –≠—Ç–æ ¬´${pressedUp}¬ª. –°–ª—É—à–∞–π –µ—â—ë —Ä–∞–∑!`);
        const useSound = elSoundMode.checked;
        const need = useSound ? (SOUND[current] || current.toLowerCase()) : current;
        const got  = useSound ? (SOUND[pressedUp] || pressedUp.toLowerCase()) : pressedUp;
        say(`–≠—Ç–æ ${useSound ? "–∑–≤—É–∫" : "–±—É–∫–≤–∞"} ${got}. –ù—É–∂–Ω–∞ ${useSound ? "–∑–≤—É–∫" : "–±—É–∫–≤–∞"} ${need}`);
      }

      if (tileEl) flashTile(tileEl, false);
    }
  }

  // ---- UI handlers ----
  document.getElementById("start").addEventListener("click", () => {
    // –ø–µ—Ä–≤—ã–π –∫–ª–∏–∫ ‚Äú—Ä–∞–∑—Ä–µ—à–∞–µ—Ç‚Äù –æ–∑–≤—É—á–∫—É
    if (!current) {
      buildGrid();
      pick();
    } else {
      const useSound = elSoundMode.checked;
      const spoken = useSound ? (SOUND[current] || current.toLowerCase()) : current;
      say(`–ù–∞–∂–º–∏ ${useSound ? "–∑–≤—É–∫" : "–±—É–∫–≤—É"} ${spoken}`);
    }
  });

  document.getElementById("next").addEventListener("click", () => {
    if (!current) buildGrid();
    pick();
  });

  document.getElementById("reset").addEventListener("click", () => {
    score = 0; 
    mistakes = 0; 
    streak = 0;
    bestStreak = 0;
    history = [];
    
    updateCounters();
    elHistory.innerHTML = '';
    elProgressBar.style.width = '0%';
    elProgressBar.textContent = '0%';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    elAchievements.querySelectorAll('.achievement').forEach(a => a.classList.remove('unlocked'));
    
    current = null;
    elTarget.textContent = "‚Äî";
    setStatus("–ù–∞–∂–º–∏ ¬´–°—Ç–∞—Ä—Ç¬ª");
    clearTileMarks();
  });

  elSet.addEventListener("change", () => {
    letters = SETS[elSet.value].slice();
    buildGrid();
    if (current) pick();
  });

  elSoundMode.addEventListener("change", () => {
    if (current) {
      const useSound = elSoundMode.checked;
      const spoken = useSound ? (SOUND[current] || current.toLowerCase()) : current;
      say(`–ù–∞–∂–º–∏ ${useSound ? "–∑–≤—É–∫" : "–±—É–∫–≤—É"} ${spoken}`);
    }
  });

  // –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ + –ø—Ä–æ–±–µ–ª –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞
  window.addEventListener("keydown", (e) => {
    if (e.code === "Space") {
      e.preventDefault();
      if (current) {
        const useSound = elSoundMode.checked;
        const spoken = useSound ? (SOUND[current] || current.toLowerCase()) : current;
        say(`–ù–∞–∂–º–∏ ${useSound ? "–∑–≤—É–∫" : "–±—É–∫–≤—É"} ${spoken}`);
      }
      return;
    }
    if (!current) return;

    const pressed = (e.key || "").toUpperCase();
    if (pressed.length !== 1) return;

    // –ø–æ–¥—Å–≤–µ—Ç–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –ø–ª–∏—Ç–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å
    const tile = [...document.querySelectorAll(".tile")].find(t => t.dataset.letter === pressed) || null;
    handleAnswer(pressed, tile);
  });
  
  // –¢–µ–º–Ω–∞—è —Ç–µ–º–∞
  elThemeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-theme');
    elThemeToggle.textContent = document.body.classList.contains('dark-theme') ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
  });
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É
  if (localStorage.getItem('theme') === 'dark') {
    document.body.classList.add('dark-theme');
    elThemeToggle.textContent = '‚òÄÔ∏è';
  }
  
  // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∑–≤—É–∫–∞
  elSoundToggle.addEventListener('click', () => {
    soundEnabled = !soundEnabled;
    elSoundToggle.classList.toggle('muted');
    elSoundToggle.textContent = soundEnabled ? 'üîä' : 'üîá';
    localStorage.setItem('sound', soundEnabled ? 'on' : 'off');
  });
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∑–≤—É–∫–∞
  if (localStorage.getItem('sound') === 'off') {
    soundEnabled = false;
    elSoundToggle.classList.add('muted');
    elSoundToggle.textContent = 'üîá';
  }

  // –Ω–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
  buildGrid();
  updateCounters();
</script>
</body>
</html>
